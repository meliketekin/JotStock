{"version":3,"file":"reactnativetracing.js","sourceRoot":"","sources":["../../../src/js/tracing/reactnativetracing.ts"],"names":[],"mappings":"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","sourcesContent":["/* eslint-disable max-lines */\nimport { Hub } from '@sentry/hub';\nimport {\n  defaultRequestInstrumentationOptions,\n  IdleTransaction,\n  registerRequestInstrumentation,\n  RequestInstrumentationOptions,\n  startIdleTransaction,\n  Transaction,\n} from '@sentry/tracing';\nimport {\n  EventProcessor,\n  Integration,\n  Transaction as TransactionType,\n  TransactionContext,\n} from '@sentry/types';\nimport { logger } from '@sentry/utils';\n\nimport { NativeAppStartResponse } from '../definitions';\nimport { RoutingInstrumentationInstance } from '../tracing/routingInstrumentation';\nimport { NATIVE } from '../wrapper';\nimport { NativeFramesInstrumentation } from './nativeframes';\nimport { StallTrackingInstrumentation } from './stalltracking';\nimport { BeforeNavigate, RouteChangeContextData } from './types';\nimport {\n  adjustTransactionDuration,\n  getTimeOriginMilliseconds,\n  isNearToNow,\n} from './utils';\n\nexport interface ReactNativeTracingOptions\n  extends RequestInstrumentationOptions {\n  /**\n   * The time to wait in ms until the transaction will be finished. The transaction will use the end timestamp of\n   * the last finished span as the endtime for the transaction.\n   * Time is in ms.\n   *\n   * Default: 1000\n   */\n  idleTimeout: number;\n\n  /**\n   * The maximum duration of a transaction before it will be marked as \"deadline_exceeded\".\n   * If you never want to mark a transaction set it to 0.\n   * Time is in seconds.\n   *\n   * Default: 600\n   */\n  maxTransactionDuration: number;\n\n  /**\n   * The routing instrumentation to be used with the tracing integration.\n   * There is no routing instrumentation if nothing is passed.\n   */\n  routingInstrumentation?: RoutingInstrumentationInstance;\n\n  /**\n   * Does not sample transactions that are from routes that have been seen any more and don't have any spans.\n   * This removes a lot of the clutter as most back navigation transactions are now ignored.\n   *\n   * Default: true\n   */\n  ignoreEmptyBackNavigationTransactions: boolean;\n\n  /**\n   * beforeNavigate is called before a navigation transaction is created and allows users to modify transaction\n   * context data, or drop the transaction entirely (by setting `sampled = false` in the context).\n   *\n   * @param context: The context data which will be passed to `startTransaction` by default\n   *\n   * @returns A (potentially) modified context object, with `sampled = false` if the transaction should be dropped.\n   */\n  beforeNavigate: BeforeNavigate;\n\n  /**\n   * Track the app start time by adding measurements to the first route transaction. If there is no routing instrumentation\n   * an app start transaction will be started.\n   *\n   * Default: true\n   */\n  enableAppStartTracking: boolean;\n\n  /**\n   * Track slow/frozen frames from the native layer and adds them as measurements to all transactions.\n   */\n  enableNativeFramesTracking: boolean;\n\n  /**\n   * Track when and how long the JS event loop stalls for. Adds stalls as measurements to all transactions.\n   */\n  enableStallTracking: boolean;\n}\n\nconst defaultReactNativeTracingOptions: ReactNativeTracingOptions = {\n  ...defaultRequestInstrumentationOptions,\n  idleTimeout: 1000,\n  maxTransactionDuration: 600,\n  ignoreEmptyBackNavigationTransactions: true,\n  beforeNavigate: (context) => context,\n  enableAppStartTracking: true,\n  enableNativeFramesTracking: true,\n  enableStallTracking: true,\n};\n\n/**\n * Tracing integration for React Native.\n */\nexport class ReactNativeTracing implements Integration {\n  /**\n   * @inheritDoc\n   */\n  public static id: string = 'ReactNativeTracing';\n  /**\n   * @inheritDoc\n   */\n  public name: string = ReactNativeTracing.id;\n\n  /** ReactNativeTracing options */\n  public options: ReactNativeTracingOptions;\n\n  public nativeFramesInstrumentation?: NativeFramesInstrumentation;\n  public stallTrackingInstrumentation?: StallTrackingInstrumentation;\n  public useAppStartWithProfiler: boolean = false;\n\n  private _getCurrentHub?: () => Hub;\n  private _awaitingAppStartData?: NativeAppStartResponse;\n  private _appStartFinishTimestamp?: number;\n\n  public constructor(options: Partial<ReactNativeTracingOptions> = {}) {\n    this.options = {\n      ...defaultReactNativeTracingOptions,\n      ...options,\n    };\n  }\n\n  /**\n   *  Registers routing and request instrumentation.\n   */\n  public setupOnce(\n    // @ts-ignore TODO\n    addGlobalEventProcessor: (callback: EventProcessor) => void,\n    getCurrentHub: () => Hub\n  ): void {\n    // eslint-disable-next-line @typescript-eslint/unbound-method\n    const {\n      traceFetch,\n      traceXHR,\n      tracingOrigins,\n      // @ts-ignore TODO\n      shouldCreateSpanForRequest,\n      routingInstrumentation,\n      enableAppStartTracking,\n      enableNativeFramesTracking,\n      enableStallTracking,\n    } = this.options;\n\n    this._getCurrentHub = getCurrentHub;\n\n    if (enableAppStartTracking) {\n      void this._instrumentAppStart();\n    }\n\n    if (enableNativeFramesTracking) {\n      this.nativeFramesInstrumentation = new NativeFramesInstrumentation(\n        addGlobalEventProcessor,\n        () => {\n          const self = getCurrentHub().getIntegration(ReactNativeTracing);\n\n          if (self) {\n            return !!self.nativeFramesInstrumentation;\n          }\n\n          return false;\n        }\n      );\n    } else {\n      NATIVE.disableNativeFramesTracking();\n    }\n\n    if (enableStallTracking) {\n      this.stallTrackingInstrumentation = new StallTrackingInstrumentation();\n    }\n\n    if (routingInstrumentation) {\n      routingInstrumentation.registerRoutingInstrumentation(\n        this._onRouteWillChange.bind(this),\n        this.options.beforeNavigate,\n        this._onConfirmRoute.bind(this)\n      );\n    } else {\n      logger.log(\n        '[ReactNativeTracing] Not instrumenting route changes as routingInstrumentation has not been set.'\n      );\n    }\n\n    registerRequestInstrumentation({\n      traceFetch,\n      traceXHR,\n      tracingOrigins,\n      shouldCreateSpanForRequest,\n    });\n  }\n\n  /**\n   * To be called on a transaction start. Can have async methods\n   */\n  public onTransactionStart(transaction: Transaction): void {\n    if (isNearToNow(transaction.startTimestamp)) {\n      // Only if this method is called at or within margin of error to the start timestamp.\n      this.nativeFramesInstrumentation?.onTransactionStart(transaction);\n      this.stallTrackingInstrumentation?.onTransactionStart(transaction);\n    }\n  }\n\n  /**\n   * To be called on a transaction finish. Cannot have async methods.\n   */\n  public onTransactionFinish(\n    transaction: Transaction,\n    endTimestamp?: number\n  ): void {\n    this.nativeFramesInstrumentation?.onTransactionFinish(transaction);\n    this.stallTrackingInstrumentation?.onTransactionFinish(\n      transaction,\n      endTimestamp\n    );\n  }\n\n  /**\n   * Called by the ReactNativeProfiler component on first component mount.\n   */\n  public onAppStartFinish(endTimestamp: number): void {\n    this._appStartFinishTimestamp = endTimestamp;\n  }\n\n  /**\n   * Instruments the app start measurements on the first route transaction.\n   * Starts a route transaction if there isn't routing instrumentation.\n   */\n  private async _instrumentAppStart(): Promise<void> {\n    if (!this.options.enableAppStartTracking || !NATIVE.enableNative) {\n      return;\n    }\n\n    const appStart = await NATIVE.fetchNativeAppStart();\n\n    if (!appStart || appStart.didFetchAppStart) {\n      return;\n    }\n\n    if (!this.useAppStartWithProfiler) {\n      this._appStartFinishTimestamp = getTimeOriginMilliseconds() / 1000;\n    }\n\n    if (this.options.routingInstrumentation) {\n      this._awaitingAppStartData = appStart;\n    } else {\n      const appStartTimeSeconds = appStart.appStartTime / 1000;\n\n      const idleTransaction = this._createRouteTransaction({\n        name: 'App Start',\n        op: 'ui.load',\n        startTimestamp: appStartTimeSeconds,\n      });\n\n      if (idleTransaction) {\n        this._addAppStartData(idleTransaction, appStart);\n      }\n    }\n  }\n\n  /**\n   * Adds app start measurements and starts a child span on a transaction.\n   */\n  private _addAppStartData(\n    transaction: IdleTransaction,\n    appStart: NativeAppStartResponse\n  ): void {\n    if (!this._appStartFinishTimestamp) {\n      logger.warn('App start was never finished.');\n      return;\n    }\n\n    const appStartTimeSeconds = appStart.appStartTime / 1000;\n\n    transaction.startChild({\n      description: appStart.isColdStart ? 'Cold App Start' : 'Warm App Start',\n      op: appStart.isColdStart ? 'app.start.cold' : 'app.start.warm',\n      startTimestamp: appStartTimeSeconds,\n      endTimestamp: this._appStartFinishTimestamp,\n    });\n\n    const appStartDurationMilliseconds =\n      this._appStartFinishTimestamp * 1000 - appStart.appStartTime;\n\n    transaction.setMeasurements(\n      appStart.isColdStart\n        ? {\n            app_start_cold: {\n              value: appStartDurationMilliseconds,\n            },\n          }\n        : {\n            app_start_warm: {\n              value: appStartDurationMilliseconds,\n            },\n          }\n    );\n  }\n\n  /** To be called when the route changes, but BEFORE the components of the new route mount. */\n  private _onRouteWillChange(\n    context: TransactionContext\n  ): TransactionType | undefined {\n    return this._createRouteTransaction(context);\n  }\n\n  /**\n   * Creates a breadcrumb and sets the current route as a tag.\n   */\n  private _onConfirmRoute(context: TransactionContext): void {\n    this._getCurrentHub?.().configureScope((scope) => {\n      if (context.data) {\n        const contextData = context.data as RouteChangeContextData;\n\n        scope.addBreadcrumb({\n          category: 'navigation',\n          type: 'navigation',\n          // We assume that context.name is the name of the route.\n          message: `Navigation to ${context.name}`,\n          data: {\n            from: contextData.previousRoute?.name,\n            to: contextData.route.name,\n          },\n        });\n      }\n\n      scope.setTag('routing.route.name', context.name);\n    });\n  }\n\n  /** Create routing idle transaction. */\n  private _createRouteTransaction(\n    context: TransactionContext\n  ): IdleTransaction | undefined {\n    if (!this._getCurrentHub) {\n      logger.warn(\n        `[ReactNativeTracing] Did not create ${context.op} transaction because _getCurrentHub is invalid.`\n      );\n      return undefined;\n    }\n\n    // eslint-disable-next-line @typescript-eslint/unbound-method\n    const { idleTimeout, maxTransactionDuration } = this.options;\n\n    const expandedContext = {\n      ...context,\n      trimEnd: true,\n    };\n\n    const hub = this._getCurrentHub();\n    const idleTransaction = startIdleTransaction(\n      hub as Hub,\n      expandedContext,\n      idleTimeout,\n      true\n    );\n\n    this.onTransactionStart(idleTransaction);\n\n    logger.log(\n      `[ReactNativeTracing] Starting ${context.op} transaction \"${context.name}\" on scope`\n    );\n\n    idleTransaction.registerBeforeFinishCallback(\n      (transaction, endTimestamp) => {\n        this.onTransactionFinish(transaction, endTimestamp);\n      }\n    );\n\n    idleTransaction.registerBeforeFinishCallback((transaction) => {\n      if (this.options.enableAppStartTracking && this._awaitingAppStartData) {\n        transaction.startTimestamp =\n          this._awaitingAppStartData.appStartTime / 1000;\n        transaction.op = 'ui.load';\n\n        this._addAppStartData(transaction, this._awaitingAppStartData);\n\n        this._awaitingAppStartData = undefined;\n      }\n    });\n\n    idleTransaction.registerBeforeFinishCallback(\n      (transaction, endTimestamp) => {\n        adjustTransactionDuration(\n          maxTransactionDuration,\n          transaction,\n          endTimestamp\n        );\n      }\n    );\n\n    if (this.options.ignoreEmptyBackNavigationTransactions) {\n      idleTransaction.registerBeforeFinishCallback((transaction) => {\n        if (\n          // eslint-disable-next-line @typescript-eslint/no-unsafe-member-access\n          transaction.data?.route?.hasBeenSeen &&\n          (!transaction.spanRecorder ||\n            transaction.spanRecorder.spans.filter(\n              (span) => span.spanId !== transaction.spanId\n            ).length === 0)\n        ) {\n          logger.log(\n            '[ReactNativeTracing] Not sampling transaction as route has been seen before. Pass ignoreEmptyBackNavigationTransactions = false to disable this feature.'\n          );\n          // Route has been seen before and has no child spans.\n          transaction.sampled = false;\n        }\n      });\n    }\n\n    return idleTransaction;\n  }\n}\n"]}